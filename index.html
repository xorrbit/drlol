<html>
<head>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.2/css/bootstrap2/bootstrap-switch.min.css" />
<script src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.2/js/bootstrap-switch.min.js"></script>

<script>
// names of locals
var teamLeaderboard = ['Highway11','Crust','xorrbit','Armand9x'];
var maps = ["gates-of-hell","miami-lights","lapocalypse","bell-labs","straight-line"];
var allTables = "";

function getTime(value) {
 time = 999999999 - parseInt(value)
 return  msToTime(time);
}

function msToTime(s) {
  var ms = s % 1000;
  s = (s - ms) / 1000;
  var secs = s % 60;
  s = (s - secs) / 60;
  var mins = s % 60;
  var hrs = (s - mins) / 60;

  return  mins + ':' + ("00" + secs).substr(-2,2) + '.' + ms;
}

function isWinnipegFPV(nameToCheck) {
//check to see if this leaderboard entry is part of the local leaderboard
    isTeamMember = false;
	teamLeaderboard.forEach(function (name) {
		if (name == nameToCheck)
		{
			isTeamMember = true;
		}
		
	});
	return isTeamMember;
}

function convertMapToTitle(map) {
	//capitalize first letter of each word
	title = map.toLowerCase().replace(/\b[a-z]/g, function(letter) {
		return letter.toUpperCase();
	});
	//replace - with a space
	title = title.replace(/-/g, ' ');
	return title;
}

function generateTable(map) {
//generate a table for the specified map
	tableHtml = "";
	tableHtml += "<table class='table' style='max-width:500px'>";
	tableHtml += "<tbody>";
	tableHtml += "<tr data-toggle='collapse' data-target='#accordion-" + map + "' class='clickable'>";
	tableHtml += "<th colspan=3 style='cursor:hand'>" + convertMapToTitle(map) + " > </th>";
	tableHtml +=  "</tr>";
	tableHtml += "<tr>";
    tableHtml += "<td colspan='3'>"
    tableHtml += "<div id='accordion-" + map + "' class='collapse'><table  class='table table-condensed table-hover' style='max-width:500px'>";
	tableHtml += "<thead><tr><th colspan=4><input type='checkbox' name='' class='toggleCheckbox' checked data-map='" + map + "' data-on-text='Local' data-off-text='Global'></th>";
	tableHtml += "<tr><th>Local<br>Rank<th>Global<br>Rank<th>Name <th>Time</thead><tbody id='" + map + "'></tbody></table></div>";
    tableHtml += "</td>"
    tableHtml += "</tr>";
    tableHtml += "</tbody>";
    tableHtml += "</table>";
	
	//$("#body").html(tableHtml);
	return tableHtml;
}

$( document ).ready(function() {
	//generate a table for each map in the array
	maps.forEach(function (map) {
		allTables += generateTable(map);
	});
	
	$('body').html(allTables);
	
	$(".toggleCheckbox").bootstrapSwitch();
	$(".toggleCheckbox").on('switchChange.bootstrapSwitch', function(event, state) {
		$('.global-' + $(this).attr('data-map')).toggle();
	});
	
	
	//retrieve leaderboard json for each map
	maps.forEach(function (map) {
		var teamMemberCount = 0;
		var entries = [];
	
		url = "drlol.py?map=" + map;
		$.getJSON( url, function( data ) 
		{
		
			obj = data;
			obj["data"]["Leaderboard"].forEach( function (item)
			{
				if (isWinnipegFPV(item.DisplayName))
				{
					teamMemberCount += 1;
					tableRow = "<tr class = 'success local-" + map + "'><td>" + teamMemberCount;
				}
				else
				{
					tableRow = "<tr class='global-" + map + "' style='display:none'><td>&nbsp;";
				}
				
				tableRow += " <td> " + (parseInt(item.Position) + 1) + "<td>" + item.DisplayName + "<td>" + getTime(item.StatValue) + "</tr>";
				entries.push( tableRow );
				
			});

			//add the table rows to the table for this map
			$('#' + map ).html(entries.join(""));


		});

	});
});

</script>

<body>
</body>

 
</html>
